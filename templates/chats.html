{% extends "layout.html" %}

{% block title %}Messages - GoAmet{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="/assets/css/chat.css?v={{ build_id }}">
{% endblock %}

{% block content %}
<div class="min-h-screen bg-goamet-navy text-white chat-page">
    <!-- Header -->
    <header class="sticky top-0 z-50 glass-morphism px-4 py-4 flex items-center justify-between shadow-2xl">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-2xl bg-gradient-to-br from-goamet-blue to-blue-700 flex items-center justify-center shadow-lg">
                <span class="font-black text-lg">G</span>
            </div>
            <div>
                <h1 class="text-lg font-black tracking-tight">Messages</h1>
                <p class="text-[10px] uppercase tracking-widest font-bold text-white/40">Best-in-class Realtime</p>
            </div>
        </div>
        <button onclick="window.location.reload()" class="w-10 h-10 rounded-full glass-morphism flex items-center justify-center transition active:scale-95">
            <svg class="w-5 h-5 text-white/70" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
        </button>
    </header>

    <!-- Chat List -->
    <main class="max-w-xl mx-auto px-2 py-4 pb-24">
        {% if conversations.len() == 0 %}
            <div class="p-8 text-center glass-morphism rounded-[32px] mt-10">
                <div class="text-4xl mb-4">ðŸ’¬</div>
                <h3 class="text-lg font-bold mb-2">No messages yet</h3>
                <p class="text-white/50 text-sm">Join activities or start a private chat to see them here.</p>
            </div>
        {% else %}
            <div class="space-y-2">
                {% for item in conversations %}
                    {% set display_title = item.conversation.title.clone().unwrap_or("Conversation".to_string()) %}
                    <a href="/chats/{{ item.conversation.conversation_id }}" 
                       class="flex items-center gap-4 p-4 rounded-[24px] transition active:scale-[0.98] hover:bg-white/5 group border border-transparent hover:border-white/10">
                        
                        <!-- Avatar -->
                        <div class="relative shrink-0">
                            <div class="w-14 h-14 rounded-2xl overflow-hidden bg-white/10 shadow-inner border border-white/5">
                                {% if item.conversation.image_asset_id.is_some() %}
                                    <img src="/images/{{ item.conversation.image_asset_id.clone().unwrap() }}" class="w-full h-full object-cover">
                                {% else if item.conversation.other_user_photo_asset_id.is_some() %}
                                    <img src="/images/{{ item.conversation.other_user_photo_asset_id.clone().unwrap() }}" class="w-full h-full object-cover">
                                {% else %}
                                    <div class="w-full h-full flex items-center justify-center text-2xl">
                                        {% if item.conversation.chat_context == "activity" %}ðŸŽ‰{% else %}ðŸ‘¤{% endif %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- Context Icon -->
                            <div class="absolute -bottom-1 -right-1 w-6 h-6 rounded-lg bg-goamet-navy border border-white/10 flex items-center justify-center text-[10px] shadow-lg">
                                {% if item.conversation.chat_context == "activity" %}
                                    <svg class="w-3 h-3 text-goamet-blue" fill="currentColor" viewBox="0 0 20 20"><path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3zM6 8a2 2 0 11-4 0 2 2 0 014 0zM16 18v-3a5.972 5.972 0 00-.75-2.906A3.005 3.005 0 0119 15v3h-3zM4.75 12.094A5.973 5.973 0 004 15v3H1v-3a3 3 0 013.75-2.906z"></path></svg>
                                {% else %}
                                    <svg class="w-3 h-3 text-white/60" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zm-4 0H9v2h2V9z" clip-rule="evenodd"></path></svg>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Content -->
                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between items-start mb-1">
                                <h3 class="font-black text-[15px] truncate pr-2 group-hover:text-goamet-blue transition-colors">{{ display_title }}</h3>
                                <span class="text-[10px] font-bold text-white/30 whitespace-nowrap tabular-nums">
                                    {{ item.last_message_at.clone().unwrap_or("".to_string()) }}
                                </span>
                            </div>
                            <div class="flex justify-between items-center gap-2">
                                <p class="text-[13px] font-medium text-white/50 truncate leading-snug">
                                    {{ item.last_message_preview.clone().unwrap_or("Start the conversation...".to_string()) }}
                                </p>
                                {% if item.conversation.relationship_status == "pending" %}
                                    <div class="unread-dot shrink-0"></div>
                                {% endif %}
                            </div>
                        </div>
                    </a>
                {% endfor %}
            </div>
        {% endif %}
    </main>

    <!-- Bottom Nav (Shared with other pages) -->
    <nav class="fixed bottom-0 left-0 right-0 h-20 glass-morphism flex items-center justify-around px-6 z-50">
        <a href="/discovery" class="flex flex-col items-center gap-1 opacity-40">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
            <span class="text-[10px] font-black uppercase tracking-tighter">Discover</span>
        </a>
        <a href="/activities" class="flex flex-col items-center gap-1 opacity-40">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
            <span class="text-[10px] font-black uppercase tracking-tighter">Events</span>
        </a>
        <a href="/chats" class="flex flex-col items-center gap-1 text-goamet-blue">
            <div class="relative">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"></path></svg>
                <div class="absolute -top-1 -right-1 w-2.5 h-2.5 bg-goamet-pink rounded-full border-2 border-goamet-navy"></div>
            </div>
            <span class="text-[10px] font-black uppercase tracking-tighter">Chats</span>
        </a>
        <a href="#" class="flex flex-col items-center gap-1 opacity-40">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
            <span class="text-[10px] font-black uppercase tracking-tighter">Profile</span>
        </a>
    </nav>
</div>
{% endblock %}