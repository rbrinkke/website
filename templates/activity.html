{% extends "layout.html" %}

    {% block title %}{{ activity.title }} - GoAmet{% endblock %}

{% block content %}
<div class="min-h-screen bg-[#F7F8FB]">
    <div class="pointer-events-none fixed inset-0">
        <div class="absolute -top-40 -right-40 h-[520px] w-[520px] rounded-full bg-goamet-blue/18 blur-3xl"></div>
        <div class="absolute -bottom-40 -left-40 h-[520px] w-[520px] rounded-full bg-goamet-pink/14 blur-3xl"></div>
    </div>

    <header class="sticky top-0 z-30 bg-white/85 backdrop-blur border-b border-black/5">
        <div class="px-4 py-3 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <a href="/activities" class="inline-flex items-center justify-center rounded-2xl h-10 w-10 bg-white border border-black/10 shadow-sm text-goamet-navy" aria-label="Terug">
                    ‚Üê
                </a>
                <div>
                    <div class="text-sm font-black tracking-wide text-goamet-navy">Activiteit</div>
                    <div class="text-[11px] font-semibold text-black/45">{{ activity.location_label }}</div>
                </div>
            </div>

            <div class="flex items-center gap-2">
                {% if activity.status == "cancelled" %}
                    <span class="inline-flex items-center rounded-full bg-red-500 px-3 py-2 text-[11px] font-black tracking-wide text-white shadow-sm">
                        GEANNULEERD
                    </span>
                {% endif %}
                {% if activity.is_joined %}
                    <span class="inline-flex items-center gap-2 rounded-full bg-goamet-blue/10 px-3 py-2 text-[11px] font-black text-goamet-blue border border-goamet-blue/15">
                        ‚úì {{ activity.my_participation_status.clone().unwrap_or("IK GA".to_string()).to_uppercase() }}
                    </span>
                {% endif %}
            </div>
        </div>

        {% if activity.notice.is_some() %}
            <div class="px-4 pb-3">
                {% if activity.notice.as_ref().unwrap() == "error" %}
                    <div class="rounded-2xl bg-red-500/10 border border-red-500/20 px-4 py-3 text-sm font-extrabold text-red-700">
                        Actie mislukt. Probeer opnieuw.
                    </div>
                {% else %}
                    <div class="rounded-2xl bg-green-500/10 border border-green-500/20 px-4 py-3 text-sm font-extrabold text-green-800">
                        {% if activity.notice.as_ref().unwrap() == "join_ok" %}Je bent aangemeld.{% endif %}
                        {% if activity.notice.as_ref().unwrap() == "leave_ok" %}Je bent afgemeld.{% endif %}
                        {% if activity.notice.as_ref().unwrap() == "owner_join_ok" %}Gebruiker is toegevoegd.{% endif %}
                        {% if activity.notice.as_ref().unwrap() == "owner_leave_ok" %}Gebruiker is verwijderd.{% endif %}
                        {% if activity.notice.as_ref().unwrap() == "waitlist_set_ok" %}Gebruiker staat nu op de wachtlijst.{% endif %}
                        {% if activity.notice.as_ref().unwrap() == "waitlist_removed_ok" %}Gebruiker is van de wachtlijst gehaald.{% endif %}
                        {% if activity.notice.as_ref().unwrap() == "waitlist_priority_ok" %}Voorrang is bijgewerkt.{% endif %}
                        <span class="text-black/50 font-black"> (dev sync volgt)</span>
                    </div>
                {% endif %}
            </div>
        {% endif %}
    </header>

    <main class="pb-28">
        <section class="mx-4 mt-4 overflow-hidden rounded-3xl shadow-glow ring-1 ring-black/5 bg-white">
            <div class="relative h-[360px]">
                {% if activity.main_photo_asset_id.is_some() %}
                    <img
                        class="absolute inset-0 h-full w-full object-cover"
                        src="/images/{{ activity.main_photo_asset_id.clone().unwrap() }}"
                        alt="{{ activity.title }}"
                        loading="lazy"
                        onerror="this.src='/assets/placeholder.svg'"
                    >
                {% else %}
                    <div class="absolute inset-0 bg-gradient-to-br from-[#6A1B9A] to-[#283593]">
                        <div class="absolute inset-0 flex items-center justify-center text-white/25 text-6xl font-black">G</div>
                    </div>
                {% endif %}

                <div class="absolute inset-0 bg-gradient-to-b from-black/0 via-black/10 to-black/90"></div>

                <div class="absolute top-4 left-4 right-4 flex items-start justify-between gap-3">
                    <div class="flex flex-wrap gap-2">
                        <span class="inline-flex items-center rounded-full bg-white/90 backdrop-blur px-3 py-2 text-[11px] font-black text-goamet-navy border border-black/10 shadow-sm">
                            {{ activity.scheduled_date_label }} ‚Ä¢ {{ activity.scheduled_time_label }}
                        </span>
                        <span class="inline-flex items-center rounded-full bg-white/90 backdrop-blur px-3 py-2 text-[11px] font-black text-black/70 border border-black/10 shadow-sm">
                            {{ activity.current_participants_count }}/{{ activity.max_participants }} deelnemers{% if activity.is_full %} ‚Ä¢ vol{% endif %}
                        </span>
                        {% if activity.waitlist_count > 0 %}
                            <span class="inline-flex items-center rounded-full bg-white/90 backdrop-blur px-3 py-2 text-[11px] font-black text-black/70 border border-black/10 shadow-sm">
                                {{ activity.waitlist_count }} op wachtlijst
                            </span>
                        {% endif %}
                    </div>
                </div>

                <div class="absolute bottom-0 left-0 right-0 p-4">
                    <div class="text-white text-[24px] font-extrabold leading-tight drop-shadow-[0_1px_2px_rgba(0,0,0,0.45)] max-h-[62px] overflow-hidden">
                        {{ activity.title }}
                    </div>

                    <div class="mt-2 flex items-center justify-between gap-3">
                        <div class="text-[13px] font-semibold text-white/75 truncate">
                            üìç {{ activity.location_label }}
                        </div>
                        {% if activity.category_name.is_some() %}
                            <span class="inline-flex items-center rounded-full bg-white/15 px-3 py-2 text-[11px] font-black text-white border border-white/15">
                                {{ activity.category_name.clone().unwrap() }}
                            </span>
                        {% endif %}
                    </div>

                    {% if activity.organizer_name.is_some() %}
                        <div class="mt-4 flex items-center gap-3">
                            <div class="h-10 w-10 rounded-full bg-white/15 border border-white/15 overflow-hidden shadow-sm">
                                {% if activity.organizer_photo_image_id.is_some() %}
                                    <img class="h-full w-full object-cover" src="/images/{{ activity.organizer_photo_image_id.clone().unwrap() }}" alt="" loading="lazy">
                                {% endif %}
                            </div>
                            <div class="min-w-0">
                                <div class="text-[11px] font-black text-white/70 tracking-wide">ORGANISATOR</div>
                                <div class="text-sm font-extrabold text-white truncate">{{ activity.organizer_name.clone().unwrap() }}</div>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </section>

        <section class="mx-4 mt-4">
            <div class="rounded-3xl bg-white shadow-sm border border-black/5 p-4">
                <div class="flex items-center justify-between">
                    <div class="text-sm font-black text-goamet-navy">Capaciteit</div>
                    <div class="text-[11px] font-extrabold text-black/45">{{ activity.current_participants_count }}/{{ activity.max_participants }}</div>
                </div>
                <div class="mt-3 h-3 rounded-full bg-black/5 overflow-hidden">
                    <div class="h-3 rounded-full bg-gradient-to-r from-goamet-blue to-goamet-pink" style="width: {{ activity.capacity_pct }}%;"></div>
                </div>
            </div>
        </section>

        <section class="mx-4 mt-4 grid gap-3">
            <div class="rounded-3xl bg-white shadow-sm border border-black/5 p-4">
                <div class="flex items-center justify-between">
                    <div class="text-sm font-black text-goamet-navy">Details</div>
                    <div class="text-[11px] font-extrabold text-black/45">{{ activity.activity_type }} ‚Ä¢ {{ activity.privacy_level }}</div>
                </div>
                {% if activity.address_label.is_some() %}
                    <div class="mt-2 text-sm font-semibold text-black/70">{{ activity.address_label.clone().unwrap() }}</div>
                {% endif %}
                {% if activity.description.is_some() %}
                    <div class="mt-3 text-sm font-semibold text-black/70 whitespace-pre-line">{{ activity.description.clone().unwrap() }}</div>
                {% endif %}
                {% if activity.tags.len() > 0 %}
                    <div class="mt-4 flex flex-wrap gap-2">
                        {% for t in activity.tags %}
                            <span class="inline-flex items-center rounded-full bg-goamet-blue/10 border border-goamet-blue/15 px-3 py-2 text-[11px] font-black text-goamet-navy">
                                #{{ t }}
                            </span>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>

            <div class="rounded-3xl bg-white shadow-sm border border-black/5 p-4">
                <div class="flex items-center justify-between">
                    <div class="text-sm font-black text-goamet-navy">Deelnemers</div>
                    <div class="text-[11px] font-extrabold text-black/45">{{ activity.participants_registered.len() }} zichtbaar</div>
                </div>

                <div class="mt-3 grid gap-2">
                    {% for p in activity.participants_registered %}
                        <div class="flex items-center justify-between gap-3 rounded-2xl border border-black/5 bg-[#FAFBFF] px-3 py-2">
                            <div class="flex items-center gap-3 min-w-0">
                                <div class="h-10 w-10 rounded-full bg-white border border-black/10 overflow-hidden shadow-sm">
                                    {% if p.photo_image_id.is_some() %}
                                        <img class="h-full w-full object-cover" src="/images/{{ p.photo_image_id.clone().unwrap() }}" alt="" loading="lazy" onerror="this.style.display='none'">
                                    {% endif %}
                                </div>
                                <div class="min-w-0">
                                    <div class="text-sm font-extrabold text-goamet-navy truncate">{{ p.name }}</div>
                                    <div class="flex flex-wrap items-center gap-2">
                                        <span class="inline-flex items-center rounded-full bg-white border border-black/10 px-2 py-1 text-[10px] font-black text-black/55">
                                            deelnemer
                                        </span>
                                        {% if p.role.is_some() %}
                                            <span class="inline-flex items-center rounded-full bg-goamet-blue/10 border border-goamet-blue/15 px-2 py-1 text-[10px] font-black text-goamet-navy">
                                                {{ p.role.clone().unwrap() }}
                                            </span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            {% if can_manage_activity %}
                                <form class="flex items-center gap-2" method="post" action="/activities/{{ activity.activity_id }}/signup">
                                    <input type="hidden" name="subject_user_id" value="{{ p.user_id }}">
                                    <input type="hidden" name="action" value="leave">
                                    <button type="submit" class="rounded-xl px-3 py-2 text-[11px] font-black bg-white border border-black/10 text-black/60 shadow-sm">
                                        Verwijder
                                    </button>
                                </form>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            </div>

            <div class="rounded-3xl bg-white shadow-sm border border-black/5 p-4">
                <div class="flex items-center justify-between">
                    <div class="text-sm font-black text-goamet-navy">Wachtlijst</div>
                    <div class="text-[11px] font-extrabold text-black/45">{{ activity.participants_waitlisted.len() }} zichtbaar</div>
                </div>

                {% if activity.am_on_waitlist %}
                    <div class="mt-3 rounded-2xl bg-goamet-pink/10 border border-goamet-pink/20 px-4 py-3 text-sm font-extrabold text-goamet-navy">
                        Jij staat op de wachtlijst{% if activity.my_waitlist_position.is_some() %} (#{{ activity.my_waitlist_position.unwrap() }}){% endif %}.
                    </div>
                {% endif %}

                <div class="mt-3 grid gap-2">
                    {% for p in activity.participants_waitlisted %}
                        <div class="flex items-center justify-between gap-3 rounded-2xl border border-black/5 bg-[#FFF7FB] px-3 py-2">
                            <div class="flex items-center gap-3 min-w-0">
                                <div class="h-10 w-10 rounded-full bg-white border border-black/10 overflow-hidden shadow-sm">
                                    {% if p.photo_image_id.is_some() %}
                                        <img class="h-full w-full object-cover" src="/images/{{ p.photo_image_id.clone().unwrap() }}" alt="" loading="lazy" onerror="this.style.display='none'">
                                    {% endif %}
                                </div>
                                <div class="min-w-0">
                                    <div class="text-sm font-extrabold text-goamet-navy truncate">{{ p.name }}</div>
                                    <div class="flex flex-wrap items-center gap-2">
                                        <span class="inline-flex items-center rounded-full bg-white border border-black/10 px-2 py-1 text-[10px] font-black text-black/55">
                                            wachtlijst
                                        </span>
                                        {% if p.role.is_some() %}
                                            <span class="inline-flex items-center rounded-full bg-goamet-pink/10 border border-goamet-pink/20 px-2 py-1 text-[10px] font-black text-goamet-navy">
                                                {{ p.role.clone().unwrap() }}
                                            </span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            {% if can_manage_activity %}
                                <div class="flex items-center gap-2">
                                    <form method="post" action="/activities/{{ activity.activity_id }}/waitlist">
                                        <input type="hidden" name="subject_user_id" value="{{ p.user_id }}">
                                        <input type="hidden" name="action" value="remove_waitlist">
                                        <button type="submit" class="rounded-xl px-3 py-2 text-[11px] font-black bg-white border border-black/10 text-black/60 shadow-sm">
                                            Verwijder
                                        </button>
                                    </form>
                                    <form method="post" action="/activities/{{ activity.activity_id }}/waitlist" class="flex items-center gap-2">
                                        <input type="hidden" name="subject_user_id" value="{{ p.user_id }}">
                                        <input type="hidden" name="action" value="set_priority">
                                        <input type="number" name="priority" min="0" max="999" value="0" class="w-20 rounded-xl border border-black/10 bg-white px-3 py-2 text-[11px] font-extrabold text-goamet-navy shadow-sm">
                                        <button type="submit" class="rounded-xl px-3 py-2 text-[11px] font-black bg-goamet-pink text-white shadow-sm">
                                            Voorrang
                                        </button>
                                    </form>
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>

                {% if can_manage_activity %}
                    <div class="mt-4 rounded-2xl border border-black/5 bg-[#FAFBFF] p-3">
                        <div class="text-[11px] font-black text-black/55 tracking-wide">OWNER: USER TOEVOEGEN</div>
                        <form method="post" action="/activities/{{ activity.activity_id }}/signup" class="mt-2 flex items-center gap-2">
                            <input type="hidden" name="action" value="join">
                            <input name="subject_user_id" class="flex-1 rounded-xl border border-black/10 bg-white px-3 py-3 text-xs font-extrabold text-goamet-navy shadow-sm" placeholder="user_id (uuid)">
                            <button type="submit" class="rounded-xl px-4 py-3 text-xs font-black bg-goamet-blue text-white shadow-sm">
                                Toevoegen
                            </button>
                        </form>
                    </div>
                {% endif %}
            </div>
        </section>
    </main>

    <div class="fixed bottom-0 left-0 right-0 z-30">
        <div class="mx-auto max-w-[480px] px-4 pb-4">
            <div class="rounded-[28px] bg-white/90 backdrop-blur border border-black/10 shadow-glow p-3 flex items-center justify-between gap-3">
                <div class="min-w-0">
                    <div class="text-[11px] font-black text-black/45">STATUS</div>
                    <div class="text-sm font-extrabold text-goamet-navy truncate">
                        {% if activity.is_joined %}
                            {% if activity.am_on_waitlist %}Op wachtlijst{% else %}Aangemeld{% endif %}
                        {% else %}
                            Niet aangemeld
                        {% endif %}
                    </div>
                </div>

                {% if activity.is_joined %}
                    <form method="post" action="/activities/{{ activity.activity_id }}/signup">
                        <input type="hidden" name="action" value="leave">
                        <button type="submit" class="rounded-2xl px-5 py-3 text-sm font-black bg-white border border-black/10 text-black/70 shadow-sm">
                            Afmelden
                        </button>
                    </form>
                {% else %}
                    <form method="post" action="/activities/{{ activity.activity_id }}/signup">
                        <input type="hidden" name="action" value="join">
                        <button type="submit" class="rounded-2xl px-5 py-3 text-sm font-black bg-goamet-pink text-white shadow-sm">
                            {% if activity.is_full %}Op wachtlijst{% else %}Deelnemen{% endif %}
                        </button>
                    </form>
                {% endif %}
            </div>
        </div>
    </div>

    <nav class="bottom-nav bg-white/85 backdrop-blur border-t border-black/5">
        <a href="/discovery" class="nav-item">
            <div class="nav-icon-container">
                <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76"></polygon></svg>
            </div>
            <span>Discovery</span>
        </a>
        <a href="/activities" class="nav-item active">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
            <span>Activiteiten</span>
        </a>
        <a href="#" class="nav-item">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
            <span>Chats</span>
        </a>
        <a href="#" class="nav-item">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
            <span>Notifications</span>
        </a>
    </nav>
</div>
{% endblock %}
