{% extends "layout.html" %}

{% block title %}Chat - GoAmet{% endblock %}

{% block content %}
<style>
    body,
    .app-container {
        background: #0b1220 !important;
    }

    /* Hard fallback: keep chat in phone-like layout even if mobile.css fails to load */
    body {
        display: flex;
        justify-content: center;
        min-height: 100vh;
    }
    .app-container {
        width: 100%;
        max-width: 420px;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
    }
</style>
	<div class="min-h-screen bg-goamet-navy" data-chat-conversation-id="{{ conversation.conversation_id }}" data-chat-current-user-id="{{ current_user_id }}" data-chat-can-send="{% if conversation.effective_mask.unwrap_or(0) >= 2 %}1{% else %}0{% endif %}">
    <div class="pointer-events-none fixed inset-0">
        <div class="absolute -top-40 -right-40 h-[520px] w-[520px] rounded-full bg-goamet-blue/10 blur-3xl"></div>
        <div class="absolute -bottom-40 -left-40 h-[520px] w-[520px] rounded-full bg-goamet-pink/10 blur-3xl"></div>
    </div>

	    <header class="sticky top-0 z-50" style="background:#0B1220; border-bottom: 1px solid rgba(255,255,255,0.12); box-shadow: 0 10px 26px rgba(0,0,0,0.30);">
	        <div class="px-4 py-3 flex items-center justify-between">
	            <a href="/chats" class="inline-flex items-center justify-center rounded-2xl h-11 w-11 bg-goamet-navy border border-white/15 shadow-sm text-white" aria-label="Terug">
	                ‚Üê
	            </a>
	            {% if conversation.other_user_photo_asset_id.is_some() %}
	                <div class="h-10 w-10 rounded-full overflow-hidden bg-white/5 shrink-0">
	                    <img
	                        src="/images/{{ conversation.other_user_photo_asset_id.clone().unwrap() }}"
	                        alt="{{ conversation.title.clone().unwrap_or("".to_string()) }}"
	                        class="h-full w-full object-cover"
	                        onerror="this.parentElement.innerHTML='üí¨'"
	                    >
	                </div>
	            {% else if conversation.image_asset_id.is_some() %}
	                <div class="h-10 w-10 rounded-full overflow-hidden bg-white/5 shrink-0">
	                    <img
	                        src="/images/{{ conversation.image_asset_id.clone().unwrap() }}"
	                        alt="{{ conversation.title.clone().unwrap_or("".to_string()) }}"
	                        class="h-full w-full object-cover"
	                        onerror="this.parentElement.innerHTML='üéâ'"
	                    >
	                </div>
	            {% endif %}
	            <div class="min-w-0 flex-1 px-3">
	                <div class="text-[14px] font-black tracking-wide text-white truncate">
	                    {{ conversation.title.clone().unwrap_or("Chat".to_string()) }}
	                </div>
	                <div class="text-[11px] font-semibold text-white/55 truncate">
	                    {% if preview_last_message_preview.is_some() %}
	                        {{ preview_last_message_preview.as_ref().unwrap() }}
	                    {% else %}
	                        {% if conversation.subtitle.is_some() %}
	                            {{ conversation.subtitle.clone().unwrap() }}
	                        {% else %}
	                            {% if conversation.chat_context == "activity" %}
	                                Activiteit chat
	                            {% else %}
	                                Priv√© chat
	                            {% endif %}
	                        {% endif %}
	                    {% endif %}
	                </div>
	                <div class="text-[10px] font-extrabold text-white/35">
	                    build {{ build_id }}
	                </div>
	            </div>
	            <div id="chat-online-indicator" class="hidden inline-flex items-center justify-center rounded-2xl h-11 w-11 bg-red-500/20 border border-red-500/50 shadow-sm text-red-400" title="Offline">
	                üî¥
	            </div>
	        </div>
	        <div class="h-[2px] bg-gradient-to-r from-goamet-blue/70 via-goamet-pink/70 to-goamet-blue/70 opacity-70"></div>
	    </header>

    <main class="px-4 pb-28 pt-4 max-w-xl mx-auto">
	        <div class="grid gap-3">
	                <div id="chat-messages-list" class="grid gap-2">
	                    {% for m in messages %}
	                        {% if m.is_deleted == 1 %}
	                            <div class="text-center text-[11px] font-semibold text-white/40 py-1">Bericht verwijderd</div>
	                        {% else %}
                            {% set is_me = (m.sender_id == current_user_id) %}
                            <div class="flex {% if is_me %}justify-end{% else %}justify-start{% endif %}">
                                <div class="{% if is_me %}bg-goamet-blue/20 border-goamet-blue/30{% else %}bg-white/5 border-white/10{% endif %} border rounded-[22px] px-4 py-3 max-w-[88%] shadow-sm">
                                    {% if m.message_type == "text" %}
                                        <div class="text-[13px] font-semibold text-white leading-snug whitespace-pre-wrap">{{ m.content.clone().unwrap_or("".to_string()) }}</div>
                                    {% else %}
                                        <div class="text-[12px] font-extrabold text-white/70">{{ m.message_type }}</div>
                                        <div class="mt-1 text-[12px] font-semibold text-white/60">Niet-rendered in offline cache</div>
                                    {% endif %}
                                    <div class="mt-2 flex items-center justify-end gap-2 text-[10px] font-bold text-white/45">
                                        <span>{{ m.created_at }}</span>
                                        {% if is_me %}
                                            {% if m.status.is_some() %}
                                                <span>¬∑</span>
                                                <span>{{ m.status.as_ref().unwrap() }}</span>
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
        </div>
    </main>

	    <div class="fixed bottom-0 left-0 right-0 z-50">
	        <div class="mx-auto max-w-xl px-4 pb-4">
	            <div class="rounded-[28px] bg-goamet-navy shadow-glow border border-white/10 p-3">
	                <div id="chat-composer" class="flex items-center gap-2">
	                    <input
	                        id="chat-input"
	                        type="text"
	                        placeholder="{% if conversation.effective_mask.unwrap_or(0) >= 2 %}Typ een bericht‚Ä¶{% else %}Read-only{% endif %}"
	                        class="flex-1 rounded-2xl px-4 py-3 text-[13px] font-extrabold text-white bg-white/5 border border-white/10 outline-none focus:border-goamet-blue/40 focus:ring-2 focus:ring-goamet-blue/25"
	                        {% if conversation.effective_mask.unwrap_or(0) < 2 %}disabled{% endif %}
	                    >
	                    <button
	                        id="chat-send"
	                        type="button"
	                        class="shrink-0 rounded-2xl h-12 w-12 grid place-items-center text-white bg-goamet-blue/20 border border-goamet-blue/30 shadow-sm disabled:opacity-50"
	                        {% if conversation.effective_mask.unwrap_or(0) < 2 %}disabled{% endif %}
	                        aria-label="Versturen"
	                        title="Versturen"
	                    >
	                        ‚û§
	                    </button>
	                </div>
	                <div id="chat-offline-notice" class="hidden text-center text-[12px] font-bold text-red-400 py-3">
	                    Offline - geen verbinding
	                </div>
	            </div>
	        </div>
	    </div>
	</div>
	<script src="/assets/js/chat_realtime.js"></script>
{% endblock %}
