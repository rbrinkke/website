{% extends "layout.html" %}

{% block title %}{{ conversation.title.clone().unwrap_or("Chat".to_string()) }} - GoAmet{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="/assets/css/chat.css?v={{ build_id }}">
{% endblock %}

{% block content %}
<div class="min-h-screen bg-goamet-navy flex flex-col chat-page" 
     data-chat-conversation-id="{{ conversation.conversation_id }}" 
     data-chat-current-user-id="{{ current_user_id }}" 
     data-chat-can-send="{% if conversation.effective_mask.unwrap_or(0) >= 2 %}1{% else %}0{% endif %}">
    
    <!-- Header -->
    <header class="sticky top-0 z-50 glass-morphism-header px-4 py-3 flex items-center gap-3">
        <a href="/chats" class="w-10 h-10 rounded-full flex items-center justify-center transition active:scale-90 hover:bg-white/5">
            <svg class="w-6 h-6 text-white/70" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15 19l-7-7 7-7"></path></svg>
        </a>
        
        <div class="w-10 h-10 rounded-xl overflow-hidden bg-white/10 shrink-0 shadow-inner">
            {% if conversation.other_user_photo_asset_id.is_some() %}
                <img src="/images/{{ conversation.other_user_photo_asset_id.clone().unwrap() }}" class="w-full h-full object-cover">
            {% else if conversation.image_asset_id.is_some() %}
                <img src="/images/{{ conversation.image_asset_id.clone().unwrap() }}" class="w-full h-full object-cover">
            {% else %}
                <div class="w-full h-full flex items-center justify-center text-xl">
                    {% if conversation.chat_context == "activity" %}ðŸŽ‰{% else %}ðŸ‘¤{% endif %}
                </div>
            {% endif %}
        </div>

        <div class="flex-1 min-w-0">
            <h2 class="text-[15px] font-black tracking-tight truncate">{{ conversation.title.clone().unwrap_or("Chat".to_string()) }}</h2>
            <div class="flex items-center gap-1.5">
                <span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span>
                <span class="text-[10px] font-bold text-white/40 uppercase tracking-widest">Live</span>
            </div>
        </div>

        <div id="chat-online-indicator" class="hidden">
            <div class="px-2 py-1 rounded-md bg-red-500/20 border border-red-500/30 text-[9px] font-black text-red-400 uppercase tracking-tighter">Offline</div>
        </div>
    </header>

    <!-- Messages -->
    <main id="chat-messages-list" class="flex-1 px-4 py-6 overflow-y-auto space-y-4">
        {% for m in messages %}
            {% if m.is_deleted == 1 %}
                <div class="flex justify-center">
                    <span class="px-3 py-1 rounded-full bg-white/5 text-[10px] font-bold text-white/30 italic">Message deleted</span>
                </div>
            {% else %}
                {% set is_me = (m.sender_id == current_user_id) %}
                <div id="msg-{{ m.message_id }}" class="flex w-full {% if is_me %}justify-end{% else %}justify-start{% endif %} animate-in fade-in slide-in-from-bottom-2 duration-300">
                    <div class="max-w-[85%] px-4 py-3 shadow-sm {% if is_me %}chat-bubble-me{% else %}chat-bubble-them{% endif %}">
                        <div class="msg-content text-[15px] leading-relaxed whitespace-pre-wrap">{{ m.content.clone().unwrap_or("".to_string()) }}</div>
                        <div class="mt-1 flex items-center justify-end gap-1.5 opacity-40 text-[10px] font-bold">
                            <span>{{ m.created_at }}</span>
                            {% if is_me %}
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endif %}
        {% endfor %}
    </main>

    <!-- Composer -->
    <div class="composer-container px-4 pb-8 pt-3">
        <div id="chat-composer" class="flex items-end gap-3 max-w-xl mx-auto">
            <div class="flex-1 relative">
                <textarea
                    id="chat-input"
                    rows="1"
                    placeholder="{% if conversation.effective_mask.unwrap_or(0) >= 2 %}Type a message...{% else %}Read-only{% endif %}"
                    class="w-full rounded-[24px] pl-5 pr-12 py-3.5 text-[15px] font-medium text-white bg-white/5 border border-white/10 outline-none focus:border-goamet-blue/40 focus:ring-2 focus:ring-goamet-blue/20 transition-all resize-none max-h-32"
                    {% if conversation.effective_mask.unwrap_or(0) < 2 %}disabled{% endif %}
                ></textarea>
                <button id="chat-emoji" class="absolute right-4 bottom-3 text-white/30 hover:text-white transition">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </button>
            </div>
            
            <button
                id="chat-schedule"
                type="button"
                class="shrink-0 w-12 h-12 rounded-full flex items-center justify-center text-white/50 bg-white/5 border border-white/10 transition active:scale-90"
                title="Schedule Message"
            >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            </button>

            <button
                id="chat-send"
                type="button"
                class="shrink-0 w-12 h-12 rounded-full flex items-center justify-center text-white bg-goamet-blue shadow-lg shadow-goamet-blue/20 transition active:scale-90 disabled:opacity-50 disabled:grayscale"
                {% if conversation.effective_mask.unwrap_or(0) < 2 %}disabled{% endif %}
            >
                <svg class="w-5 h-5 translate-x-0.5" fill="currentColor" viewBox="0 0 20 20"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"></path></svg>
            </button>
        </div>
        
        <div id="chat-offline-notice" class="hidden text-center py-4">
            <div class="inline-flex items-center gap-2 px-4 py-2 rounded-2xl bg-red-500/10 border border-red-500/20 text-red-400 text-xs font-black">
                <span class="w-2 h-2 rounded-full bg-red-500"></span>
                Disconnected. Retrying...
            </div>
        </div>
    </div>
</div>

<script src="/assets/js/chat_realtime.js?v={{ build_id }}"></script>
{% endblock %}